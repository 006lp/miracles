/*
 *  The main JavaScript file for Theme Miracles
 *
 *  @Author:  Eltrac
 *  @License: MIT
 */

/**
 *  Use cookies
 */
//add cookie
function addCookie(name, value, expireHours) {
    var cookieString = name + "=" + escape(value);
    if (expireHours > 0) {
        var date = new Date();
        date.setTime(date.getTime + expireHours * 3600 * 1000);
        cookieString = cookieString + "; expire=" + date.toGMTString();
    }
    document.cookie = cookieString;
}
//Delete cookie
function deleteCookie(name) {
    var date = new Date();
    date.setTime(date.getTime() - 10000);
    document.cookie = name + "=v; expire=" + date.toGMTString();
}
//Get cookie
function getCookie(cname) {
    var name = cname + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var ca = decodedCookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}

/**
 *  Base Animation
 *  基础动画
 */
function scaleIn(object, time) {
    object.css('transition', time).css('transform', 'scale(0)');
    object.show();
    object.css('transform', 'scale(1)');
}

function scaleOut(object, time) {
    object.css('transition', time).css('transform', 'scale(0)')
}

/**
 *  Dark theme
 */
//toggleDark
function Dark() {
    //Add classs to use dark theme
    $("body").toggleClass("body-dark");
    //Add cookie to record
    if ($("body").hasClass("body-dark")) {
        addCookie("darkTheme", "on", 9);
    } else {
        addCookie("darkTheme", "off", 9);
    }
}

/**
 *  Use filters
 */
//toggleGray
function Gray() {
    $("html").toggleClass("html-filter-gray");
    $("html").removeClass("html-filter-sepia");
    //add cookie to record
    if ($("html").hasClass("html-filter-gray")) {
        addCookie("grayFilter", "on", 0);
    } else {
        addCookie("grayFilter", "off", 0);
    }
}
//toggleSepia

function Sepia() {
    $("html").toggleClass("html-filter-sepia");
    $("html").removeClass("html-filter-gray");
    //add cookie to record
    if ($("html").hasClass("html-filter-sepia")) {
        addCookie("sepiaFilter", "on", 0);
    } else {
        addCookie("sepiaFilter", "off", 0);
    }
}

/**
 *  Explore and load themes/filter
 */
//explore and load dark theme
var whetherDark = getCookie("darkTheme");
var whetherGray = getCookie("grayFilter");
var whetherSepia = getCookie("sepiaFilter");
var schemeGeter = window.matchMedia ("(prefers-color-scheme: dark)");
if (whetherDark == "on" || schemeGeter.matches) {
    $("body").addClass("body-dark");
} else if (whetherGray == "on") {
    $("html").addClass("html-filter-gray");
} else if (whetherSepia == "on") {
    $("html").addClass("html-filter-sepia");
}
//支持系统深色模式
function swDarkMode(scheme){
    if(scheme.matches)
    $("body").addClass("body-dark");
    else if(window.matchMedia ("(prefers-color-scheme: light)").matches)
    $("body").removeClass("body-dark");
}
schemeGeter.addListener(swDarkMode);

/**
 *  GoTop
 */
function GoTop() {
    $('body,html').animate({
        scrollTop: 0
    }, 500);
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
}
$('#gotop').hide();
$(window).scroll(function() {
    if ($(window).scrollTop() > 450) {
        scaleIn($('#gotop'), '0.7');
    } else {
        scaleOut($('#gotop'), '0.7');
    }
});

/**
 *  Js Loader
 */
//LazyLoad
function LazyLoad() {
    jQuery(function() {
        jQuery("img").lazyload({
            threshold: 200,
            effect: "fadeIn"
        });
    });
}
//highlight

function highlight() {
    $(document).ready(function() {
        $('pre code').each(function(i, block) {
            hljs.highlightBlock(block);
            hljs.lineNumbersBlock(block, {
                singleLine: true
            });
        })
    });
}
//owo

function owoLoad() {
    var OwO_demo = new OwO({
        logo: 'OωO表情',
        container: document.getElementsByClassName('OwO')[0],
        target: document.getElementsByClassName('OwO-textarea')[0],
        api: owoJson,
        position: 'down',
        width: '300px',
        maxHeight: '250px'
    });
}
//Pangu.js

function panguLoad() {
    document.addEventListener('DOMContentLoaded', () => {
        pangu.autoSpacingPage();
    });
}

/**
 *  Prevent Scroll
 */
function bodyScroll(event) {
    event.preventDefault();
}

/**
 *  Front Options Pannel
 */
//FontFamily
function ChangeToSerif() {
    $('body').addClass('body-serif');
    $('.options-serif-button').addClass('options-button-active');
    $('.options-sans-button').removeClass('options-button-active');
}

function ChangeToSansSerif() {
    $('body').removeClass('body-serif');
    $('.options-serif-button').removeClass('options-button-active');
    $('.options-sans-button').addClass('options-button-active');
}
//SizeContent

function SizeSmall() {
    //add class for body
    $('body').addClass('body-contentsize-small');
    $('body').removeClass('body-contentsize-normal');
    $('body').removeClass('body-contentsize-big');
    $('body').removeClass('body-contentsize-large');
    //active button
    $('.options-sizesmall').addClass('options-button-active');
    $('.options-sizenormal').removeClass('options-button-active');
    $('.options-sizebig').removeClass('options-button-active');
    $('.options-sizelarge').removeClass('options-button-active');
}

function SizeNormal() {
    $('body').removeClass('body-contentsize-small');
    $('body').addClass('body-contentsize-normal');
    $('body').removeClass('body-contentsize-big');
    $('body').removeClass('body-contentsize-large');
    //active button
    $('.options-sizesmall').removeClass('options-button-active');
    $('.options-sizenormal').addClass('options-button-active');
    $('.options-sizebig').removeClass('options-button-active');
    $('.options-sizelarge').removeClass('options-button-active');
}

function SizeBig() {
    $('body').removeClass('body-contentsize-small');
    $('body').removeClass('body-contentsize-normal');
    $('body').addClass('body-contentsize-big');
    $('body').removeClass('body-contentsize-large');
    //active button
    $('.options-sizesmall').removeClass('options-button-active');
    $('.options-sizenormal').removeClass('options-button-active');
    $('.options-sizebig').addClass('options-button-active');
    $('.options-sizelarge').removeClass('options-button-active');
}

function SizeLarge() {
    $('body').removeClass('body-contentsize-small');
    $('body').removeClass('body-contentsize-normal');
    $('body').removeClass('body-contentsize-big');
    $('body').addClass('body-contentsize-large');
    //active button
    $('.options-sizesmall').removeClass('options-button-active');
    $('.options-sizenormal').removeClass('options-button-active');
    $('.options-sizebig').removeClass('options-button-active');
    $('.options-sizelarge').addClass('options-button-active');
}

/**
 *  Open pannel
 */
//Search
function Search() {
    $(".search").toggleClass("ready");
    $(".search-close").toggleClass("ready");
}
//Login

function Login() {
    $(".login").toggleClass("ready");
    $(".login-close").toggleClass("ready");
    //Ban or allow scroll
}

/**
 *  Drawer
 */
function toggleDrawer() {
    $("body").toggleClass("drawer-open");
    $(".mask").toggleClass("mask-open");
}

/**
 *  Alert
 */
function alertSend(content, auto) {
    $(".alert-content").text(content);
    $(".alert").removeClass("ready");
    if (auto === true) {
        window.setTimeout(function() {
            $(".alert").addClass("ready");
        }, 2000);
    }
}

function alertClose() {
    $(".alert").addClass("ready");
}

/**
 *  Listen copy event and alert
 */
$(document).ready(function() {
    $("body").bind({
        copy: function() {
            alertSend("复制成功！若使用请注明原作者及原地址！", true);
        }
    });
});

/**
 *  Event Listeners
 */
/* GetElementById */
function idGetEl(id) {
    var el = document.getElementById(id);
    return el;
}

/* Find Elements */
var goTopButton = idGetEl("gotop");
var fullMask = idGetEl("full-mask");
var searchCloseButton = idGetEl("search-close-button");
var searchOpenButton = idGetEl("search-open-button");
var searchOpenMobile = idGetEl("search-open-mobile");
var loginCloseButton = idGetEl("login-close");
var loginOpenButton = idGetEl("login-open");
var loginOpenMobile = idGetEl("login-open-mobile");
var toggleMobileMenuClose = idGetEl("toggle-mobile-menu-close");
var toggleMobileMenu = idGetEl("toggle-mobile-menu-button");
var toggleOptions = idGetEl("toggle-options-button");
var toggleOptionsMobile = idGetEl("toggle-options-mobile");
var alertCloseButton = idGetEl("alert-close");
var drawerButton = idGetEl("drawer-button");
var navBar = idGetEl("navBar");
var navBarMobile = idGetEl("navBarMobile");

/* Add Listeners */
//返回顶部按钮
goTopButton.addEventListener("click", GoTop);
//全屏遮罩（抽屉栏）
fullMask.addEventListener("click", function() {
    toggleDrawer();
    $('.options').addClass('ready');
});
//打开/关闭搜索面板
searchCloseButton.addEventListener("click", Search);
searchOpenButton.addEventListener("click", Search);
searchOpenMobile.addEventListener("click", Search);
//打开/关闭登录面板
loginCloseButton.addEventListener("click", Login);
loginOpenButton.addEventListener("click", Login);
loginOpenMobile.addEventListener("click", Login);
//开关移动端导航
toggleMobileMenuClose.addEventListener("click", function() {
    $(".mobile-menu").toggleClass("ready");
    $(".mobile-menu-close").toggleClass("ready");
});
toggleMobileMenu.addEventListener("click", function() {
    $(".mobile-menu").toggleClass("ready");
    $(".mobile-menu-close").toggleClass("ready");
});
//开关设置面板
toggleOptions.addEventListener("click", function() {
    $(".options").toggleClass("ready");
});
toggleOptionsMobile.addEventListener("click", function() {
    $(".options").toggleClass("ready");
});
//关闭 Alert
alertCloseButton.addEventListener("click", alertClose);

/**
 *  Load Pjax
 */
if (loadPjax = true) {
    $(document).pjax('a[href^="' + siteurl + '"]:not(a[target="_blank"], a[no-pjax], .comment-reply a, .cancel-comment-reply a)', {
        container: '#pjax-container',
        fragment: '#pjax-container',
        timeout: 8000
    }).on('pjax:send', function() {
        GoTop();
        //Others
        beforePjax();
    }).on('pjax:complete', function() {
        //Front-end Login
        $('form#login-form').addClass('need-refresh');
        //Close Mobile Menu after pjax finishes
        $(".mobile-menu").addClass("ready");
        $(".mobile-menu-close").addClass("ready");
        //Animation
        $(".post-list").addClass("fadein").hide().fadeIn(300);
        $(".post-body").addClass("fadein").hide().fadeIn(300);
        $(".comment").addClass("fadein").hide().fadeIn(300);
        $("#pjax-container").css({
            'height': 'auto'
        });
        //NProgress
        NProgress.done();
        //Reload
        LazyLoad();
        highlight();
        panguLoad();
        getWordsNum();
        navColor();
        //Others
        afterPjax();
    });
}

/**
 *  Comply First
 */
(function() {
    panguLoad();
    LazyLoad();
    highlight();
    navUpdate();
    getWordsNum();
    navColor();
})();
/**
 * NavBar Scroll Change
 */
var navBar_height = navBar.clientHeight

    function navUpdate() {
		if(allowNavAero==true) {
            var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
            if (scrollTop > navBar_height) {
                navBar.classList.remove("nav-aero");
                navBarMobile.classList.remove("nav-aero");
            } else {
                navBar.classList.add("nav-aero");
                navBarMobile.classList.add("nav-aero");

            }
		}
    }
$(window).scroll(function() {
    navUpdate();
})
/**
 * Navbar font update
 */
function navColor() {
    if (idGetEl("banner-content").className.indexOf("banner-font-black") == -1) {
        navBar.classList.add("nav-font-white");
        navBarMobile.classList.add("nav-font-white");
    } else {
        navBar.classList.remove("nav-font-white");
        navBarMobile.classList.remove("nav-font-white");
    }
}
/**
 * getWordsNum
 */
function getWordsNum() {
    if (idGetEl("post-content"))
        str = idGetEl("post-content").innerText;
    else return false;
    sLen = 0;
    str = str.replace(/(\r\n+|\s+|　+)/g, "龘");
    str = str.replace(/[\x00-\xff]/g, "m");
    str = str.replace(/m+/g, "*");
    str = str.replace(/龘+/g, "");
    sLen = str.length;
    time = Math.ceil(sLen / 450);
    idGetEl("readTip").innerHTML = "本文约 " + sLen + "字 阅读大概需要 " + time + " 分钟";
}
/**
 * Build Time Echo
 */
function startTime(time = '2010-01-01') {
    startTimeV = time;
    var $time = new Date().getTime() - new Date(startTimeV);
    if ($time < 0) return '0秒';
    let result = '';
    if ($time >= 365 * 86400000) {
        result += parseInt($time / (365 * 86400000)) + ' 年 ';
        $time = ($time % (365 * 86400000));
    }
    if ($time >= 86400000) {
        result += parseInt($time / 86400000) + ' 天 ';
        $time = ($time % 86400000);
    }
    if ($time >= 3600000) {
        result += parseInt($time / 3600000) + ' 小时 ';
        $time = ($time % 3600000);
    }
    if ($time >= 60000) {
        result += parseInt($time / 60000) + ' 分 ';
        $time = ($time % 60000);
    }
    result += parseInt($time / 1000) + ' 秒 ';
    $('#build-time').html(result);
    buildTimeout = setTimeout('startTime(startTimeV)', 1000)
}
/**
 *  Copyright
 */
console.log("%c 🎉 Theme Miracles %c by Eltrac %c 仓库: https://github.com/BigCoke233/miracles %c 演示：https://guhub.cn", "color: #fff; margin: 1em 0; padding: 5px 0; background: #29c75f;", "margin: 1em 0; padding: 5px 0; background: #efefef;", "display: block;margin-left:-0.5em;", "display: block;margin-left:-0.5em;margin-bottom:1em");